name: bigdataspark

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${PG_USER:-bigdata}
      POSTGRES_PASSWORD: ${PG_PASSWORD:-bigdata}
      POSTGRES_DB: ${PG_DB:-bigdata}
    ports:
      - "${PG_PORT_EXTERNAL:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro
      - "./исходные данные:/data:ro"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 20

  clickhouse:
    image: clickhouse/clickhouse-server:24.6
    restart: unless-stopped
    ports:
      - "${CH_HTTP_PORT_EXTERNAL:-8123}:8123"
      - "${CH_NATIVE_PORT_EXTERNAL:-9000}:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./docker/clickhouse/init:/docker-entrypoint-initdb.d:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query 'SELECT 1'"]
      interval: 5s
      timeout: 5s
      retries: 20

  spark:
    build:
      context: ./spark
    depends_on:
      postgres:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    volumes:
      - ./spark/jobs:/opt/jobs:ro
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: ${PG_DB:-bigdata}
      PG_USER: ${PG_USER:-bigdata}
      PG_PASSWORD: ${PG_PASSWORD:-bigdata}
      PG_RAW_TABLE: mock_data
      PG_DWH_SCHEMA: dwh

      CH_HOST: clickhouse
      CH_PORT: 8123
      CH_DB: ${CH_DB:-reports}
      CH_USER: ${CH_USER:-default}
      CH_PASSWORD: ${CH_PASSWORD:-}
    command: ["sleep", "infinity"]

  cassandra:
    image: cassandra:4.1
    profiles: ["extras"]
    restart: unless-stopped
    ports:
      - "${CASSANDRA_PORT_EXTERNAL:-9042}:9042"
    volumes:
      - cassandra_data:/var/lib/cassandra

  mongo:
    image: mongo:7
    profiles: ["extras"]
    restart: unless-stopped
    ports:
      - "${MONGO_PORT_EXTERNAL:-27017}:27017"
    volumes:
      - mongo_data:/data/db

  neo4j:
    image: neo4j:5
    profiles: ["extras"]
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/password}
    ports:
      - "${NEO4J_HTTP_PORT_EXTERNAL:-7474}:7474"
      - "${NEO4J_BOLT_PORT_EXTERNAL:-7687}:7687"
    volumes:
      - neo4j_data:/data

  valkey:
    image: valkey/valkey:7.2
    profiles: ["extras"]
    restart: unless-stopped
    ports:
      - "${VALKEY_PORT_EXTERNAL:-6379}:6379"

volumes:
  postgres_data:
  clickhouse_data:
  cassandra_data:
  mongo_data:
  neo4j_data:
